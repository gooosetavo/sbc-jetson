# References:
#   U-Boot:
#     - https://u-boot.readthedocs.io/en/latest
name: u-boot
variant: scratch
shell: /bin/bash
dependencies:
  - stage: base
steps:
  - sources:
      - url: https://github.com/u-boot/u-boot/archive/refs/tags/v2026.01.tar.gz
        destination: u-boot.tar.bz2
        sha256: 03bb43c58d2343ee48dd191e0f181f0108425b179d84519add3a977071c3f654 
        sha512: bf621285c526afbd22886ace2f04554dad3edc0b0d3c1bd095a851abe6e78676d1197904670a02e745959d83825bc798136970b9b1b87759c1891e4e77e11c01
    env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
    prepare:
      - |
        tar xf u-boot.tar.bz2 --strip-components=1
        # Build for Jetson Nano (Tegra210)
        make p3450-0000_defconfig
        sed -i "s/CONFIG_TOOLS_LIBCRYPTO=y/# CONFIG_TOOLS_LIBCRYPTO is not set/" .config
    build:
      - |
        # Build U-Boot for Jetson Nano
        make -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto"
        cp u-boot.bin u-boot-jetson-nano.bin
        
        # Build U-Boot for Orin Nano (Tegra234) if config exists
        if [ -f configs/p3767-0000_defconfig ]; then
          make distclean
          make p3767-0000_defconfig
          sed -i "s/CONFIG_TOOLS_LIBCRYPTO=y/# CONFIG_TOOLS_LIBCRYPTO is not set/" .config
          make -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto"
          cp u-boot.bin u-boot-jetson-orin-nano.bin
        fi
        
        # Build U-Boot for AGX Orin (Tegra234) if config exists
        if [ -f configs/p3701-0000_defconfig ]; then
          make distclean
          make p3701-0000_defconfig
          sed -i "s/CONFIG_TOOLS_LIBCRYPTO=y/# CONFIG_TOOLS_LIBCRYPTO is not set/" .config
          make -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto"
          cp u-boot.bin u-boot-jetson-agx-orin.bin
        fi
    install:
      - |
        mkdir -p /rootfs/artifacts/arm64/u-boot/jetson_nano
        mkdir -p /rootfs/artifacts/arm64/u-boot/jetson_orin_nano
        mkdir -p /rootfs/artifacts/arm64/u-boot/jetson_agx_orin
        
        cp -v u-boot-jetson-nano.bin /rootfs/artifacts/arm64/u-boot/jetson_nano/u-boot.bin
        
        # Copy Orin binaries if they were built
        if [ -f u-boot-jetson-orin-nano.bin ]; then
          cp -v u-boot-jetson-orin-nano.bin /rootfs/artifacts/arm64/u-boot/jetson_orin_nano/u-boot.bin
        fi
        
        if [ -f u-boot-jetson-agx-orin.bin ]; then
          cp -v u-boot-jetson-agx-orin.bin /rootfs/artifacts/arm64/u-boot/jetson_agx_orin/u-boot.bin
        fi
finalize:
  - from: /rootfs
    to: /rootfs
